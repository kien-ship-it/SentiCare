# SWE

**Technical Specification for Cloud & Web Application**

---

**Project:** SentiCare - AI-Powered Patient Wellness Monitoring System
**Version:** 1.1
**Audience:** Software Engineer (Backend/Frontend)

---

### **1. System Architecture Overview**

As the Software Engineer on this project, you are responsible for the entire cloud-based infrastructure and the user-facing web application. The system follows an **event-driven architecture**. The AI Client acts as the primary data producer, writing directly to Google Firestore. Your backend services will be **reactive**, triggering logic based on these database events. The frontend will subscribe to Firestore for real-time data visualization.

Your responsibilities are divided into two main areas: the **Backend (Cloud Functions & APIs)** and the **Frontend (React Dashboard)**.

**Data Flow:**

1. **AI Client (Producer):** Analyzes video and writes event, alert, and status data directly to Firestore.
2. **Firestore (Event Bus):** Acts as the central database and message bus.
3. **Cloud Functions (Reactive Backend):** Triggered by new documents in Firestore to perform tasks like sending notifications and aggregating data.
4. **React Frontend (Consumer):** Listens for real-time changes in Firestore to display live dashboards and alerts.
5. **Node.js API (Service Endpoint):** Provides specific services that require server-side logic, such as interfacing with the Gemini AI chat agent.

### **2. Your Core Responsibilities**

- **Backend:**
    - Implement Cloud Functions to handle notifications and data aggregation.
    - Set up and manage the Firebase project, including Firestore rules and Authentication.
    - Build a secure Node.js API endpoint to handle requests for the AI Chat Agent.
    - Integrate the Twilio SMS service for sending critical alerts.
    - Integrate the Firebase Gemini API for data summarization.
- **Frontend:**
    - Develop the React.js single-page application for the user dashboard.
    - Implement user authentication flows using the Firebase Authentication SDK.
    - Utilize the Firestore SDK to create real-time listeners for live data updates on the dashboard.
    - Create data visualizations (charts, graphs) for patient wellness metrics.
    - Build the UI for the AI Chat Agent and the alert management system.

---

### **3. Firestore Data Models (Your Data Contract)**

You will be the primary consumer of the following Firestore collections. The AI Engineer is responsible for producing data that conforms to these schemas. Your code should be built to read and interpret these structures.

### **Collection: `events` (Source for Aggregation)**

- **Description:** A historical log of all routine patient activities.
- **Your Role:** You will write a Cloud Function that triggers on document creation in this collection.
- **Schema (Read-Only):**
    - `patientId` (String)
    - `roomId` (String)
    - `timestamp` (Timestamp): Time the event concluded.
    - `eventType` (String): e.g., `SITTING`, `WALKING`, `IN_BED`, **`NOT_PRESENT`**.
    - `durationSeconds` (Number)
    - `confidenceScore` (Number)

---

### **Collection: `alerts` (Source for Notifications)**

- **Description:** A log of critical events requiring immediate action.
- **Your Role:** Write a Cloud Function triggered on document creation. Also, the frontend will read from this and allow users to update the `acknowledged` field.
- **Schema (Read/Update):**
    - patientId (String)
    - roomId (String)
    - timestamp (Timestamp)
    - alertType (String): FALL_DETECTED or HELP_SIGNAL_DETECTED.
    - acknowledged (Boolean): Defaults to false. Your frontend will update this to true.
    - **acknowledgedBy (String, optional): The uid of the user who acknowledged the alert.**
    - confidenceScore (Number)

### **Collection: `patientStatus` (Source for Live View)**

- **Description:** A single document per patient showing their current, real-time state.
- **Your Role:** Your frontend will subscribe to this document for the "Live Status" component on the dashboard.
- **Schema (Read-Only):**
    - **Document ID:** `{patientId}`
    - `currentState` (String)
    - `stateStartTime` (Timestamp)
    - `lastSeen` (Timestamp): Use this to determine if the system is online (e.g., if `lastSeen` > 5 minutes ago, show a "Disconnected" status).
    - `roomId` (String)

---

### **Collection: `dailySummaries` (Source for Dashboard Charts)**

- **Description:** Pre-aggregated data for efficient dashboard loading.
- **Your Role:** Your Cloud Function will create and update these documents. Your frontend will read from this collection to populate all historical charts and graphs.
- **Schema (Write via Backend, Read via Frontend):**
    - **Document ID:** `{patientId}_{YYYY-MM-DD}`
    - `patientId` (String)
    - `summaryDate` (Timestamp)
    - `wellnessScore` (Number): Populated on-demand by the Gemini Chat Agent API call.
    - `roomMetrics` (Map<String, Object>): A map where the key is the `roomId`.
        - `{roomId}`:
            - `timeInBedSeconds` (Number)
            - `sittingTimeSeconds` (Number)
            - `standingTimeSeconds` (Number)
            - `walkingTimeSeconds` (Number)
            - `idleTimeSeconds` (Number)
            - **`notPresentTimeSeconds` (Number)**
            - `fallCount` (Number)
            - `helpSignalCount` (Number)
    - `lastUpdated` (Timestamp)

---

### **4. Backend Implementation Guide (Cloud Functions & API)**

### **A. Cloud Function: `onAlertCreated`**

- **Trigger:** `onCreate` on documents in the `alerts` collection (`/alerts/{alertId}`).
- **Logic:**
    1. Read the newly created alert document's data (`patientId`, `alertType`, `roomId`).
    2. Query the `patients` and `users` collections to find the patient's name and the phone numbers of assigned caregivers.
    3. Format a clear, concise SMS message (e.g., "SentiCare Alert: A potential fall has been detected for [Patient Name] in the [Room Name] at [Time]. Please check immediately.").
    4. Use the Twilio SDK to send the SMS to all subscribed caregivers.
    5. Implement robust error handling and logging.

### **B. Cloud Function: `onEventCreated`**

- **Trigger:** `onCreate` on documents in the `events` collection (`/events/{eventId}`).
- **Logic:**
    1. Read the event data (`patientId`, `eventType`, `durationSeconds`, `roomId`, `timestamp`).
    2. Determine the summary document ID (e.g., `pXT5a..._2023-10-26`).
    3. Use a **Firestore Transaction** to safely read the `dailySummaries` document.
    4. If the document doesn't exist, create it with initial zeroed values.
    5. Increment the appropriate counter based on `eventType`. For example, if `eventType` is `SITTING`, increment `roomMetrics.{roomId}.sittingTimeSeconds` by `durationSeconds`. **If `eventType` is `NOT_PRESENT`, increment `roomMetrics.{roomId}.notPresentTimeSeconds`.**
    6. Update the `lastUpdated` timestamp.
    7. Commit the transaction. Using a transaction is crucial to prevent race conditions.

### **C. API Endpoint: AI Chat Agent**

- **Endpoint:** `POST /api/v1/chat/summarize`
- **Authentication:** Protect this endpoint using Firebase Auth middleware (check for a valid user token).
- **Request Body (JSON):**
    
    ```json
    {
      "patientId": "pXT5aC3gQd9F8hJ2kL5n",
      "date": "2023-10-26", // Optional, defaults to yesterday
      "query": "Summarize yesterday's activity and give me a wellness score."
    }
    ```
    
- **Backend Logic:**
    1. Authenticate the user and verify they have access to the patientId.
    2. Fetch the relevant dailySummaries document from Firestore based on patientId and date.
    3. Format the summary data into a clean, human-readable context for the AI. Example: "Patient Data for 2023-10-26: Time in Bed: 8.2 hours, Sitting Time: 6.5 hours, Walking Time: 1.1 hours, Falls: 0."
    4. Construct a prompt for Gemini, combining the formatted context with the user's query. **Instruct Gemini to include a wellness score from 1-100 in its response (e.g., "Wellness Score: 85/100").**
    5. Call the Firebase Gemini API with the prompt.
    6. **From the Gemini response, parse the wellness score (e.g., extract the number 85).**
    7. **Perform an asynchronous update operation on the dailySummaries document, setting the wellnessScore field with the parsed value.**
    8. Return the full natural language response from Gemini to the frontend.
- **Success Response (200 OK):**
    
    ```json
    {
      "response": "Based on yesterday's data, the patient had a restful night with 8.2 hours in bed. Their mobility was moderate, with over an hour of walking time. There were no falls detected. The overall wellness score is 85/100, indicating a positive day."
    }
    
    ```
    

### **5. Frontend Implementation Guide (React.js)**

- **Authentication:** Use the `firebase/auth` SDK for sign-in, sign-up, and session persistence (`onAuthStateChanged`). Implement protected routes for the dashboard.
- **Real-time Data:** Use the `onSnapshot` method from the `firebase/firestore` SDK to listen for changes.
    - Listen to the `patientStatus` document for the patient to display the "Live Status" card.
    - Listen to the `alerts` collection (where `acknowledged == false`) to display a real-time notification banner.
- **Dashboard Visualizations:**
    - Fetch data from the `dailySummaries` collection for a selected date range.
    - Use a charting library (e.g., Chart.js, Recharts) to render bar charts for `timeInBedSeconds`, `sittingTimeSeconds`, **`notPresentTimeSeconds` (labeled as "Time Away"),** etc.
- **Alert Acknowledgment:**
    - When a user clicks "Acknowledge" on an alert, trigger a Firestore `update` operation on the specific document in the `alerts` collection, setting `acknowledged: true` and `acknowledgedBy: currentUser.uid`.

### **6. Setup & Environment**

- **Firebase CLI:** You will need the Firebase CLI for deploying Cloud Functions and Firestore security rules.
- **Environment Variables:** Your backend services will require environment variables stored securely (e.g., in Cloud Secret Manager or `.env` files for local development):
    - `TWILIO_ACCOUNT_SID`
    - `TWILIO_AUTH_TOKEN`
    - `TWILIO_PHONE_NUMBER`
    - `GEMINI_API_KEY` (if not using the integrated Firebase Gen AI SDK)
- **Firestore Security Rules:** You are responsible for writing security rules that ensure users can only read data for patients they are assigned to and can only write to fields they are permitted to (e.g., the `acknowledged` field on an alert).